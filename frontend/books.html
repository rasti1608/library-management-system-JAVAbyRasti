<!--
    Library Management System - Books Page
    Created by: [Your Name]
    Date: September 18, 2025
    Description: Frontend interface for browsing, searching, and managing book rentals
    Connects to Spring Boot REST API on localhost:8085
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books - Library Management System</title>
    <style>
        /* Basic styling for the books page */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            color: #333;
        }
        
        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background-color: #c82333;
        }
        
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-form button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .search-form button:hover {
            background-color: #0056b3;
        }
        
        .books-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .book-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .book-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .book-author {
            color: #666;
            margin-bottom: 5px;
        }
        
        .book-genre {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .book-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .status-available {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-rented {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .rent-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        
        .rent-btn:hover {
            background-color: #218838;
        }
        
        .rent-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .return-btn {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        
        .return-btn:hover {
            background-color: #e0a800;
        }
        
        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
        }
        
        .pagination button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover {
            background-color: #0056b3;
        }
        
        .pagination button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            margin: 0 15px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Library Books</h1>
        <div class="user-info">
            <span id="userWelcome">Welcome!</span>
            <a href="admin.html" id="adminLink" style="display: none; text-decoration: none; background-color: #17a2b8; color: white; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">Admin Panel</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="search-section">
        <h3>Search Books</h3>
        <div class="search-form">
            <input type="text" id="searchQuery" placeholder="Search by title..." />
            <input type="text" id="searchAuthor" placeholder="Search by author..." />
            <button onclick="searchBooks()">Search</button>
            <button onclick="loadAllBooks()">Show All</button>
        </div>
    </div>
    
    <div class="books-container">
        <div id="message" class="message"></div>
        <div id="loadingMessage" class="loading">Loading books...</div>
        
        <!-- Pagination controls -->
        <div id="paginationTop" class="pagination" style="display: none;">
            <button onclick="goToPage(0)">First</button>
            <button id="prevBtn" onclick="previousPage()">Previous</button>
            <span class="page-info">
                Page <span id="currentPage">1</span> of <span id="totalPages">1</span> 
                (<span id="totalBooks">0</span> books)
            </span>
            <button id="nextBtn" onclick="nextPage()">Next</button>
            <button id="lastBtn" onclick="goToLastPage()">Last</button>
        </div>
        
        <div id="booksGrid" class="books-grid"></div>
        
        <!-- Bottom pagination (same as top) -->
        <div id="paginationBottom" class="pagination" style="display: none;">
            <button onclick="goToPage(0)">First</button>
            <button onclick="previousPage()">Previous</button>
            <span class="page-info">
                Page <span class="current-page">1</span> of <span class="total-pages">1</span>
            </span>
            <button onclick="nextPage()">Next</button>
            <button onclick="goToLastPage()">Last</button>
        </div>
    </div>

    <script>
        // Base URL for our Spring Boot API
        const API_BASE_URL = 'http://localhost:8085';
        
        // Pagination state
        let currentPageNum = 0;
        let pageSize = 20; // Show 12 books per page
        let totalPages = 0;
        let totalBooksCount = 0;
        let lastSearchParams = null; // Remember last search to maintain filter after rent/return
        
        /**
         * Load all books when page loads
         */
document.addEventListener('DOMContentLoaded', function() {
    checkUserRole(); // Check if user is admin to show admin link
    loadBooks();
});
 
 /**
 * Check user role and show admin link if user is admin
 */
async function checkUserRole() {
    try {
        // Try to access admin endpoint to check if user is admin
        const response = await fetch(`${API_BASE_URL}/books`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                title: "ADMIN_TEST",
                author: "TEST", 
                genre: "TEST"
            })
        });
        
        if (response.status === 403) {
            // User is not admin - got forbidden
            console.log('User is not admin');
        } else {
            // User has admin access - show admin link
            document.getElementById('adminLink').style.display = 'inline-block';
            console.log('User is admin - showing admin link');
        }
        
    } catch (error) {
        // If request fails, user is not admin
        console.log('User is not admin - request failed');
    }
}
        
        /**
         * Load books with pagination
         */
        async function loadBooks(page = 0, searchParams = null) {
            showLoading(true);
            hideMessage();
            
            // Build URL with pagination
            let url = `${API_BASE_URL}/books?page=${page}&size=${pageSize}`;
            if (searchParams) {
                url += `&${searchParams.toString()}`;
                lastSearchParams = searchParams; // Remember search
            } else {
                lastSearchParams = null; // Clear search
            }
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBooks(data.content || data);
                    updatePagination(data);
                } else if (response.status === 401) {
                    window.location.href = 'index.html';
                } else {
                    showMessage('Failed to load books', 'error');
                }
                
            } catch (error) {
                console.error('Error loading books:', error);
                showMessage('Connection error. Make sure your Spring Boot server is running.', 'error');
            }
            
            showLoading(false);
        }
        
        /**
         * Load all books (for backward compatibility)
         */
        function loadAllBooks() {
            loadBooks(0); // Load first page
        }
        
        /**
         * Search books with pagination
         */
        async function searchBooks() {
            const query = document.getElementById('searchQuery').value.trim();
            const author = document.getElementById('searchAuthor').value.trim();
            
            const params = new URLSearchParams();
            if (query) params.append('title', query);
            if (author) params.append('author', author);
            
            currentPageNum = 0; // Reset to first page for new search
            loadBooks(0, params);
        }
        
        /**
         * Update pagination controls
         */
        function updatePagination(data) {
            currentPageNum = data.page || 0;
            totalPages = data.totalPages || 1;
            totalBooksCount = data.total || (data.content || data).length;
            
            // Update page info
            document.getElementById('currentPage').textContent = currentPageNum + 1;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalBooks').textContent = totalBooksCount;
            
            // Update bottom pagination
            document.querySelectorAll('.current-page').forEach(el => el.textContent = currentPageNum + 1);
            document.querySelectorAll('.total-pages').forEach(el => el.textContent = totalPages);
            
            // Enable/disable buttons
            const prevBtns = document.querySelectorAll('#prevBtn, .pagination button:nth-child(2)');
            const nextBtns = document.querySelectorAll('#nextBtn, .pagination button:nth-child(4)');
            const lastBtns = document.querySelectorAll('#lastBtn, .pagination button:nth-child(5)');
            
            prevBtns.forEach(btn => btn.disabled = currentPageNum === 0);
            nextBtns.forEach(btn => btn.disabled = currentPageNum >= totalPages - 1);
            lastBtns.forEach(btn => btn.disabled = currentPageNum >= totalPages - 1);
            
            // Show pagination if more than one page
            const showPagination = totalPages > 1;
            document.getElementById('paginationTop').style.display = showPagination ? 'flex' : 'none';
            document.getElementById('paginationBottom').style.display = showPagination ? 'flex' : 'none';
        }
        
        /**
         * Navigation functions
         */
        function nextPage() {
            if (currentPageNum < totalPages - 1) {
                loadBooks(currentPageNum + 1, lastSearchParams);
            }
        }
        
        function previousPage() {
            if (currentPageNum > 0) {
                loadBooks(currentPageNum - 1, lastSearchParams);
            }
        }
        
        function goToPage(page) {
            loadBooks(page, lastSearchParams);
        }
        
        function goToLastPage() {
            loadBooks(totalPages - 1, lastSearchParams);
        }
        
        /**
         * Display books in the grid
         */
        function displayBooks(books) {
            const grid = document.getElementById('booksGrid');
            
            if (!books || books.length === 0) {
                grid.innerHTML = '<p>No books found.</p>';
                return;
            }
            
            grid.innerHTML = books.map(book => `
                <div class="book-card">
                    <div class="book-title">${escapeHtml(book.title)}</div>
                    <div class="book-author">by ${escapeHtml(book.author)}</div>
                    <div class="book-genre">${escapeHtml(book.genre || 'No genre')}</div>
                    <div class="book-status ${book.status === 'AVAILABLE' ? 'status-available' : 'status-rented'}">
                        ${book.status}
                    </div>
                    ${book.status === 'AVAILABLE' 
                        ? `<button class="rent-btn" onclick="rentBook('${book.id}')">Rent Book</button>`
                        : `<button class="return-btn" onclick="returnBook('${book.id}')">Return Book</button>`
                    }
                </div>
            `).join('');
        }
        
        /**
         * Rent a book
         */
        async function rentBook(bookId) {
            try {
                const response = await fetch(`${API_BASE_URL}/books/${bookId}/rent`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showMessage('Book rented successfully!', 'success');
                    loadBooks(currentPageNum, lastSearchParams); // Maintain current page and search
                } else if (response.status === 401) {
                    window.location.href = 'index.html';
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.error || 'Failed to rent book', 'error');
                }
                
            } catch (error) {
                console.error('Error renting book:', error);
                showMessage('Error renting book', 'error');
            }
        }
        
        /**
         * Return a book
         */
        async function returnBook(bookId) {
            try {
                const response = await fetch(`${API_BASE_URL}/books/${bookId}/return`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showMessage('Book returned successfully!', 'success');
                    loadBooks(currentPageNum, lastSearchParams); // Maintain current page and search
                } else if (response.status === 401) {
                    window.location.href = 'index.html';
                } else {
                    const errorData = await response.json();
                    showMessage(errorData.error || 'Failed to return book', 'error');
                }
                
            } catch (error) {
                console.error('Error returning book:', error);
                showMessage('Error returning book', 'error');
            }
        }
        
        /**
         * Logout user
         */
        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Redirect to login page regardless of response
            window.location.href = 'index.html';
        }
        
        /**
         * Show/hide loading message
         */
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }
        
        /**
         * Show message to user
         */
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    hideMessage();
                }, 3000);
            }
        }
        
        /**
         * Hide message
         */
        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }
        
        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Allow Enter key to trigger search
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
        
        document.getElementById('searchAuthor').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
    </script>
</body>
</html>